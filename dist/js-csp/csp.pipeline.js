"use strict";

var csp = require('./csp.core');

function pipelineInternal(n, to, from, close, taskFn) {
  if (n <= 0) {
    throw new Error('n must be positive');
  }

  var jobs = csp.chan(n);
  var results = csp.chan(n);

  for (var _ = 0; _ < n; _++) {
    csp.go(regeneratorRuntime.mark(function callee$1$0(taskFn, jobs, results) {
      var job;

      return regeneratorRuntime.wrap(function callee$1$0$(context$2$0) {
        while (1) {
          switch (context$2$0.prev = context$2$0.next) {
            case 0:
              if (!true) {
                context$2$0.next = 9;
                break;
              }

              context$2$0.next = 3;
              return csp.take(jobs);
            case 3:
              job = context$2$0.sent;

              if (taskFn(job)) {
                context$2$0.next = 7;
                break;
              }

              results.close();
              return context$2$0.abrupt("break", 9);
            case 7:
              context$2$0.next = 0;
              break;
            case 9:
            case "end":
              return context$2$0.stop();
          }
        }
      }, callee$1$0, this);
    }), [taskFn, jobs, results]);
  }

  csp.go(regeneratorRuntime.mark(function callee$1$1(jobs, from, results) {
    var v, p;

    return regeneratorRuntime.wrap(function callee$1$1$(context$2$0) {
      while (1) {
        switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!true) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 3;
            return csp.take(from);
          case 3:
            v = context$2$0.sent;

            if (!(v === csp.CLOSED)) {
              context$2$0.next = 9;
              break;
            }

            jobs.close();
            return context$2$0.abrupt("break", 16);
          case 9:
            p = csp.chan(1);
            context$2$0.next = 12;
            return csp.put(jobs, [v, p]);
          case 12:
            context$2$0.next = 14;
            return csp.put(results, p);
          case 14:
            context$2$0.next = 0;
            break;
          case 16:
          case "end":
            return context$2$0.stop();
        }
      }
    }, callee$1$1, this);
  }), [jobs, from, results]);

  csp.go(regeneratorRuntime.mark(function callee$1$2(results, close, to) {
    var p, res, v;

    return regeneratorRuntime.wrap(function callee$1$2$(context$2$0) {
      while (1) {
        switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!true) {
              context$2$0.next = 26;
              break;
            }

            context$2$0.next = 3;
            return csp.take(results);
          case 3:
            p = context$2$0.sent;

            if (!(p === csp.CLOSED)) {
              context$2$0.next = 9;
              break;
            }

            if (close) {
              to.close();
            }
            return context$2$0.abrupt("break", 26);
          case 9:
            context$2$0.next = 11;
            return csp.take(p);
          case 11:
            res = context$2$0.sent;
          case 12:
            if (!true) {
              context$2$0.next = 24;
              break;
            }

            context$2$0.next = 15;
            return csp.take(res);
          case 15:
            v = context$2$0.sent;

            if (!(v !== csp.CLOSED)) {
              context$2$0.next = 21;
              break;
            }

            context$2$0.next = 19;
            return csp.put(to, v);
          case 19:
            context$2$0.next = 22;
            break;
          case 21:
            return context$2$0.abrupt("break", 24);
          case 22:
            context$2$0.next = 12;
            break;
          case 24:
            context$2$0.next = 0;
            break;
          case 26:
          case "end":
            return context$2$0.stop();
        }
      }
    }, callee$1$2, this);
  }), [results, close, to]);

  return to;
}

function pipeline(to, xf, from, keepOpen, exHandler) {

  function taskFn(job) {
    if (job === csp.CLOSED) {
      return null;
    } else {
      var v = job[0];
      var p = job[1];
      var res = csp.chan(1, xf, exHandler);

      csp.go(regeneratorRuntime.mark(function callee$2$0(res, v) {
        return regeneratorRuntime.wrap(function callee$2$0$(context$3$0) {
          while (1) {
            switch (context$3$0.prev = context$3$0.next) {
              case 0:
                context$3$0.next = 2;
                return csp.put(res, v);
              case 2:
                res.close();
              case 3:
              case "end":
                return context$3$0.stop();
            }
          }
        }, callee$2$0, this);
      }), [res, v]);

      csp.putAsync(p, res);

      return true;
    }
  }

  return pipelineInternal(1, to, from, !keepOpen, taskFn);
}

function pipelineAsync(n, to, af, from, keepOpen) {

  function taskFn(job) {
    if (job === csp.CLOSED) {
      return null;
    } else {
      var v = job[0];
      var p = job[1];
      var res = csp.chan(1);
      af(v, res);
      csp.putAsync(p, res);
      return true;
    }
  }

  return pipelineInternal(n, to, from, !keepOpen, taskFn);
}

module.exports = {
  pipeline: pipeline,
  pipelineAsync: pipelineAsync
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy1jc3AvY3NwLnBpcGVsaW5lLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7QUFFYixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7O0FBRWhDLFNBQVMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRTtBQUNwRCxNQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDVixVQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7R0FDdkM7O0FBRUQsTUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QixNQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUUxQixPQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3pCLE9BQUcsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsVUFBVSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO0FBQ3hFLFVBQUksR0FBRyxDQUFDOztBQUVSLGFBQU8sa0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsV0FBVyxDQUFDLFdBQVcsRUFBRTtBQUMvRCxlQUFPLENBQUM7QUFBRSxrQkFBUSxXQUFXLENBQUMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJO0FBQ3JELGlCQUFLLENBQUM7QUFDSixrQkFBSSxDQUFDLElBQUksRUFBRTtBQUNULDJCQUFXLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztBQUNyQixzQkFBTTtlQUNQOztBQUVELHlCQUFXLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztBQUNyQixxQkFBTyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQUEs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QUFPLElBQUksQ0FBQztLQUNiO0dBQ0Y7O0FBRUQsU0FBTyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztDQUN6RDs7QUFFRCxTQUFTLGFBQWEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFOztBQUVoRCxXQUFTLE1BQU0sQ0FBQyxHQUFHLEVBQUU7QUFDbkIsUUFBSSxHQUFHLEtBQUssR0FBRyxDQUFDLE1BQU0sRUFBRTtBQUN0QixhQUFPLElBQUksQ0FBQztLQUNiLE1BQU07QUFDTCxVQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDZixVQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDZixVQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RCLFFBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDWCxTQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNyQixhQUFPLElBQUksQ0FBQztLQUNiO0dBQ0Y7O0FBRUQsU0FBTyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztDQUN6RDs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsVUFBUSxFQUFFLFFBQVE7QUFDbEIsZUFBYSxFQUFFLGFBQWE7Q0FDN0IsQ0FBQyIsImZpbGUiOiJjc3AucGlwZWxpbmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxudmFyIGNzcCA9IHJlcXVpcmUoJy4vY3NwLmNvcmUnKTtcblxuZnVuY3Rpb24gcGlwZWxpbmVJbnRlcm5hbChuLCB0bywgZnJvbSwgY2xvc2UsIHRhc2tGbikge1xuICBpZiAobiA8PSAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCduIG11c3QgYmUgcG9zaXRpdmUnKTtcbiAgfVxuXG4gIHZhciBqb2JzID0gY3NwLmNoYW4obik7XG4gIHZhciByZXN1bHRzID0gY3NwLmNoYW4obik7XG5cbiAgZm9yKHZhciBfID0gMDsgXyA8IG47IF8rKykge1xuICAgIGNzcC5nbyhyZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBjYWxsZWUkMSQwKHRhc2tGbiwgam9icywgcmVzdWx0cykge1xuICAgICAgdmFyIGpvYjtcblxuICAgICAgcmV0dXJuIHJlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIGNhbGxlZSQxJDAkKGNvbnRleHQkMiQwKSB7XG4gICAgICAgIHdoaWxlICgxKSBzd2l0Y2ggKGNvbnRleHQkMiQwLnByZXYgPSBjb250ZXh0JDIkMC5uZXh0KSB7XG4gICAgICAgIGNhc2UgMDpcbiAgICAgICAgICBpZiAoIXRydWUpIHtcbiAgICAgICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSA5O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDM7XG4gICAgICAgICAgcmV0dXJuIGNzcC50YWtlKGpvYnMpO1xuICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgam9iID0gY29udGV4dCQyJDAuc2VudDtcblxuICAgICAgICAgIGlmICh0YXNrRm4oam9iKSkge1xuICAgICAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXN1bHRzLmNsb3NlKCk7XG4gICAgICAgICAgcmV0dXJuIGNvbnRleHQkMiQwLmFicnVwdChcImJyZWFrXCIsIDkpO1xuICAgICAgICBjYXNlIDc6XG4gICAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgOTpcbiAgICAgICAgY2FzZSBcImVuZFwiOlxuICAgICAgICAgIHJldHVybiBjb250ZXh0JDIkMC5zdG9wKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIGNhbGxlZSQxJDAsIHRoaXMpO1xuICAgIH0pLCBbdGFza0ZuLCBqb2JzLCByZXN1bHRzXSk7XG4gIH1cblxuICBjc3AuZ28ocmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gY2FsbGVlJDEkMShqb2JzLCBmcm9tLCByZXN1bHRzKSB7XG4gICAgdmFyIHYsIHA7XG5cbiAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gY2FsbGVlJDEkMSQoY29udGV4dCQyJDApIHtcbiAgICAgIHdoaWxlICgxKSBzd2l0Y2ggKGNvbnRleHQkMiQwLnByZXYgPSBjb250ZXh0JDIkMC5uZXh0KSB7XG4gICAgICBjYXNlIDA6XG4gICAgICAgIGlmICghdHJ1ZSkge1xuICAgICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAxNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAzO1xuICAgICAgICByZXR1cm4gY3NwLnRha2UoZnJvbSk7XG4gICAgICBjYXNlIDM6XG4gICAgICAgIHYgPSBjb250ZXh0JDIkMC5zZW50O1xuXG4gICAgICAgIGlmICghKHYgPT09IGNzcC5DTE9TRUQpKSB7XG4gICAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBqb2JzLmNsb3NlKCk7XG4gICAgICAgIHJldHVybiBjb250ZXh0JDIkMC5hYnJ1cHQoXCJicmVha1wiLCAxNik7XG4gICAgICBjYXNlIDk6XG4gICAgICAgIHAgPSBjc3AuY2hhbigxKTtcbiAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDEyO1xuICAgICAgICByZXR1cm4gY3NwLnB1dChqb2JzLCBbdiwgcF0pO1xuICAgICAgY2FzZSAxMjpcbiAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDE0O1xuICAgICAgICByZXR1cm4gY3NwLnB1dChyZXN1bHRzLCBwKTtcbiAgICAgIGNhc2UgMTQ6XG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAwO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMTY6XG4gICAgICBjYXNlIFwiZW5kXCI6XG4gICAgICAgIHJldHVybiBjb250ZXh0JDIkMC5zdG9wKCk7XG4gICAgICB9XG4gICAgfSwgY2FsbGVlJDEkMSwgdGhpcyk7XG4gIH0pLCBbam9icywgZnJvbSwgcmVzdWx0c10pO1xuXG4gIGNzcC5nbyhyZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBjYWxsZWUkMSQyKHJlc3VsdHMsIGNsb3NlLCB0bykge1xuICAgIHZhciBwLCByZXMsIHY7XG5cbiAgICByZXR1cm4gcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gY2FsbGVlJDEkMiQoY29udGV4dCQyJDApIHtcbiAgICAgIHdoaWxlICgxKSBzd2l0Y2ggKGNvbnRleHQkMiQwLnByZXYgPSBjb250ZXh0JDIkMC5uZXh0KSB7XG4gICAgICBjYXNlIDA6XG4gICAgICAgIGlmICghdHJ1ZSkge1xuICAgICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAyNjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAzO1xuICAgICAgICByZXR1cm4gY3NwLnRha2UocmVzdWx0cyk7XG4gICAgICBjYXNlIDM6XG4gICAgICAgIHAgPSBjb250ZXh0JDIkMC5zZW50O1xuXG4gICAgICAgIGlmICghKHAgPT09IGNzcC5DTE9TRUQpKSB7XG4gICAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2xvc2UpIHtcbiAgICAgICAgICB0by5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb250ZXh0JDIkMC5hYnJ1cHQoXCJicmVha1wiLCAyNik7XG4gICAgICBjYXNlIDk6XG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAxMTtcbiAgICAgICAgcmV0dXJuIGNzcC50YWtlKHApO1xuICAgICAgY2FzZSAxMTpcbiAgICAgICAgcmVzID0gY29udGV4dCQyJDAuc2VudDtcbiAgICAgIGNhc2UgMTI6XG4gICAgICAgIGlmICghdHJ1ZSkge1xuICAgICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAyNDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAxNTtcbiAgICAgICAgcmV0dXJuIGNzcC50YWtlKHJlcyk7XG4gICAgICBjYXNlIDE1OlxuICAgICAgICB2ID0gY29udGV4dCQyJDAuc2VudDtcblxuICAgICAgICBpZiAoISh2ICE9PSBjc3AuQ0xPU0VEKSkge1xuICAgICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAyMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnRleHQkMiQwLm5leHQgPSAxOTtcbiAgICAgICAgcmV0dXJuIGNzcC5wdXQodG8sIHYpO1xuICAgICAgY2FzZSAxOTpcbiAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDIyO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMjE6XG4gICAgICAgIHJldHVybiBjb250ZXh0JDIkMC5hYnJ1cHQoXCJicmVha1wiLCAyNCk7XG4gICAgICBjYXNlIDIyOlxuICAgICAgICBjb250ZXh0JDIkMC5uZXh0ID0gMTI7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyNDpcbiAgICAgICAgY29udGV4dCQyJDAubmV4dCA9IDA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyNjpcbiAgICAgIGNhc2UgXCJlbmRcIjpcbiAgICAgICAgcmV0dXJuIGNvbnRleHQkMiQwLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9LCBjYWxsZWUkMSQyLCB0aGlzKTtcbiAgfSksIFtyZXN1bHRzLCBjbG9zZSwgdG9dKTtcblxuICByZXR1cm4gdG87XG59XG5cbmZ1bmN0aW9uIHBpcGVsaW5lKHRvLCB4ZiwgZnJvbSwga2VlcE9wZW4sIGV4SGFuZGxlcikge1xuXG4gIGZ1bmN0aW9uIHRhc2tGbihqb2IpIHtcbiAgICBpZiAoam9iID09PSBjc3AuQ0xPU0VEKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHYgPSBqb2JbMF07XG4gICAgICB2YXIgcCA9IGpvYlsxXTtcbiAgICAgIHZhciByZXMgPSBjc3AuY2hhbigxLCB4ZiwgZXhIYW5kbGVyKTtcblxuICAgICAgY3NwLmdvKHJlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIGNhbGxlZSQyJDAocmVzLCB2KSB7XG4gICAgICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBjYWxsZWUkMiQwJChjb250ZXh0JDMkMCkge1xuICAgICAgICAgIHdoaWxlICgxKSBzd2l0Y2ggKGNvbnRleHQkMyQwLnByZXYgPSBjb250ZXh0JDMkMC5uZXh0KSB7XG4gICAgICAgICAgY2FzZSAwOlxuICAgICAgICAgICAgY29udGV4dCQzJDAubmV4dCA9IDI7XG4gICAgICAgICAgICByZXR1cm4gY3NwLnB1dChyZXMsIHYpO1xuICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgIHJlcy5jbG9zZSgpO1xuICAgICAgICAgIGNhc2UgMzpcbiAgICAgICAgICBjYXNlIFwiZW5kXCI6XG4gICAgICAgICAgICByZXR1cm4gY29udGV4dCQzJDAuc3RvcCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgY2FsbGVlJDIkMCwgdGhpcyk7XG4gICAgICB9KSwgW3Jlcywgdl0pO1xuXG4gICAgICBjc3AucHV0QXN5bmMocCwgcmVzKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBpcGVsaW5lSW50ZXJuYWwoMSwgdG8sIGZyb20sICFrZWVwT3BlbiwgdGFza0ZuKTtcbn1cblxuZnVuY3Rpb24gcGlwZWxpbmVBc3luYyhuLCB0bywgYWYsIGZyb20sIGtlZXBPcGVuKSB7XG5cbiAgZnVuY3Rpb24gdGFza0ZuKGpvYikge1xuICAgIGlmIChqb2IgPT09IGNzcC5DTE9TRUQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgdiA9IGpvYlswXTtcbiAgICAgIHZhciBwID0gam9iWzFdO1xuICAgICAgdmFyIHJlcyA9IGNzcC5jaGFuKDEpO1xuICAgICAgYWYodiwgcmVzKTtcbiAgICAgIGNzcC5wdXRBc3luYyhwLCByZXMpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBpcGVsaW5lSW50ZXJuYWwobiwgdG8sIGZyb20sICFrZWVwT3BlbiwgdGFza0ZuKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHBpcGVsaW5lOiBwaXBlbGluZSxcbiAgcGlwZWxpbmVBc3luYzogcGlwZWxpbmVBc3luY1xufTtcbiJdfQ==